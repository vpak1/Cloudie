# ============================================
# Production Deployment Pipeline
# ============================================

name: Production Deployment

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ==========================================
  # JOB 1: RUN UNIT TESTS
  # ==========================================
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install and test
        run: |
          npm ci
          npm run build
          # UPDATED: Exclude smoke tests (they require a running server)
          npm test -- --testPathIgnorePatterns=src/smoke.test.js
        env:
          CI: true

  # ==========================================
  # JOB 2: SECURITY CHECKS
  # ==========================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Security audit
        run: |
          npm ci
          # Checks for high-risk vulnerabilities
          npm audit --audit-level=high || echo "Vulnerabilities found - review required"

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          # Basic check for password assignments
          if grep -rn "password\s*=\s*['\"]" --include="*.js" . 2>/dev/null | grep -v "process.env"; then
            echo "⚠️ WARNING: Potential hardcoded password found!"
          else
            echo "✅ No obvious hardcoded passwords found"
          fi

  # ==========================================
  # JOB 3: PRODUCTION DOCKER VERIFICATION
  # ==========================================
  production-docker:
    name: Production Docker Build & Verify
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start production container
        run: |
          docker compose build production
          docker compose up production -d
          echo "Waiting for container to start (Production takes longer)..."
          sleep 15 

      - name: Verify production deployment
        run: |
          echo "Checking production health endpoint on Port 6000..."
          
          # We use curl here instead of smoke.test.js because 
          # smoke.test.js is hardcoded to port 5000 (Staging).
          
          # 1. Health Check
          curl -f http://localhost:6000/health || exit 1
          
          echo ""
          echo "Checking production homepage..."
          # 2. Homepage Check
          curl -f http://localhost:6000/ || exit 1
          
          echo ""
          echo "✅ Production deployment verified!"

      - name: Verify production security
        run: |
          echo "Verifying production security settings..."
          
          # Check that stack traces are NOT exposed (Security Best Practice)
          RESPONSE=$(curl -s http://localhost:6000/nonexistent-endpoint-12345)
          
          # If the response contains "stack" or "trace", fail the build
          if echo "$RESPONSE" | grep -qi "stack\|trace"; then
            echo "❌ CRITICAL: Stack traces are exposed in production!"
            exit 1
          else
            echo "✅ No stack traces exposed in error responses"
          fi

      - name: Cleanup
        if: always()
        run: docker compose down

  # ==========================================
  # JOB 4: SUMMARY
  # ==========================================
  production-summary:
    name: Production Summary
    runs-on: ubuntu-latest
    needs: [test, security, production-docker]
    
    steps:
      - name: Create Release Summary
        run: |
          echo "============================================"
          echo "  PRODUCTION DEPLOYMENT READY"
          echo "============================================"
          echo "  Branch:      main"
          echo "  Environment: PRODUCTION"
          echo "  Port:        6000 (Internal) / 6001 (Browser)"
          echo ""
          echo "  All checks passed:"
          echo "    ✅ Unit Tests"
          echo "    ✅ Security Audit"
          echo "    ✅ Production Container Verification"
          echo "============================================"